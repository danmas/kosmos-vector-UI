# Изменения в API контракте

Документ описывает изменения, внесенные в API контракт (`docs/api-contract.yaml`).

## Обзор изменений

### 1. Обязательный параметр `context-code` для всех маршрутов
### 2. Новый маршрут для запуска шага 1 pipeline
### 3. Поле `report` в статусе шага pipeline
### 4. Маршруты для получения истории выполнения шагов
### 5. Расширение количества шагов (до 7)
### 6. Новая модель конфигурации базы знаний (`/api/kb-config`)
### 7. Новая модель дерева файлов проекта (`/api/project/tree`)
### 8. Гибкое поле `language` без жёсткого enum

---

## 1. Обязательный параметр `context-code`

**Дата изменения:** 2024-11-20

**Описание:** Добавлен обязательный query-параметр `context-code` для всех API маршрутов. Этот параметр используется для изоляции данных между различными контекстами (проектами).

**Изменения:**
- Все маршруты теперь требуют параметр `context-code` в query string
- Параметр валидируется через Express middleware
- При отсутствии параметра возвращается ошибка `400 Bad Request`

**Пример использования:**
```
GET /api/items?context-code=CARL
POST /api/pipeline/step/1/run?context-code=CARL
```

**Обратная совместимость:** ❌ Требует обновления клиентов

---

## 2. Маршрут запуска шага 1 pipeline

**Дата изменения:** 2024-12-10

**Новый маршрут:** `POST /api/pipeline/step/1/run`

**Описание:** Запускает выполнение шага 1 pipeline (Polyglot Parsing) в фоновом режиме. Шаг обрабатывает SQL-файлы и схемы таблиц для указанного контекста.

**Параметры:**
- `context-code` (query, обязательный) — код контекста для изоляции данных

**Ответ:**
```json
{
  "success": true,
  "message": "Шаг 1 запущен в фоновом режиме",
  "step": {
    "id": 1,
    "name": "parsing",
    "status": "running",
    ...
  }
}
```

**Особенности:**
- Выполнение происходит асинхронно (fire-and-forget)
- Блокирует повторный запуск, если шаг уже выполняется (статус `running`) → `409 Conflict`

**Мониторинг прогресса:**
- Используйте `GET /api/pipeline/steps/status?context-code=CARL`

---

## 3. Поле `report` в статусе шага

**Дата изменения:** 2024-12-12

**Описание:** Добавлено опциональное поле `report` в схему `PipelineStepStatus`. Содержит детальный отчет о выполнении шага после его завершения.

**Пример отчета для шага 1:**
```json
{
  "summary": {
    "totalFiles": 5,
    "totalTables": 10,
    "totalFunctions": 25,
    "totalAiItems": 35,
    "totalChunks": 50,
    "errors": 2,
    "skipped": 1
  },
  "details": {
    "sqlFiles": [...],
    "tables": [...],
    "errors": [...]
  }
}
```

**Доступно:** только после `completed` или `failed`

---

## 4. Маршруты для получения истории выполнения шагов

**Дата изменения:** 2024-12-15

**Новые маршруты:**
- `GET /api/pipeline/steps/history?context-code=CARL`
- `GET /api/pipeline/step/{id}/history?context-code=CARL`

**Описание:** Возвращают историю изменений статуса шагов pipeline с временными метками, прогрессом и отчетами.

**Особенности:**
- История хранится в памяти (теряется при рестарте)
- Поддержка фильтрации по `stepId` и ограничения `limit`

---

## 5. Расширение количества шагов

**Дата изменения:** 2024-12-15

**Описание:** Количество шагов pipeline расширено с 5 до 7.

**Изменения:**
- Поддержка ID шагов: 1, 2, 3, 4, 5, 6, 7
- Обновлена схема `PipelineStepStatus.id`

**Обратная совместимость:** ✅

---

## 6. Новая модель конфигурации базы знаний (KnowledgeBaseConfig)

**Дата изменения:** 2025-12-17

**Новые маршруты:**
- `GET /api/kb-config?context-code=CARL` — получение текущей конфигурации
- `POST /api/kb-config?context-code=CARL` — обновление конфигурации (частичный патч)

**Описание:** Централизованное хранение настроек проекта:
- `rootPath` — абсолютный путь к проекту на сервере
- `includeMask` — glob-паттерн включаемых файлов
- `ignorePatterns` — паттерны игнорирования
- `fileSelection` — точный список выбранных файлов (приоритет над маской)
- `metadata` — произвольные метаданные
- `lastUpdated` — время последнего изменения

**Хранение:** JSON-файлы в `./data/kb-configs/{context-code}.json`

**Особенности:**
- Автоматическое создание дефолтной конфигурации при первом обращении
- Приоритет `fileSelection` над glob-масками (по контракту)
- Конфигурация используется в pipeline (в т.ч. шаг 1)

**Дефолтные значения:**
```json
{
  "rootPath": "<project-root>/docs",
  "includeMask": "**/*.{sql,js,ts,tsx,py,java,go}",
  "ignorePatterns": "**/node_modules/**,**/venv/**,**/__pycache__/**,**/dist/**,**/.git/**",
  "fileSelection": [],
  "metadata": { "projectName": "New Project" }
}
```

---

## 7. Новая модель дерева файлов проекта

**Дата изменения:** 2025-12-17

**Новый маршрут:** `GET /api/project/tree?context-code=CARL`

**Описание:** Возвращает иерархическое дерево файлов и папок от `rootPath` с полной информацией по схеме `ProjectFile`.

**Ответ:** массив корневых узлов (дети корневой директории)

**Ключевые особенности:**
- Использует `includeMask`, `ignorePatterns` и `fileSelection` из `kb-config`
- Флаг `selected` рассчитывается автоматически:
  - **Режим 1 (точный выбор)**: Если `fileSelection` не пустой → файлы из списка получают `selected: true`, остальные → `false`
  - **Режим 2 (glob-маски)**: Если `fileSelection` пустой → файлы, соответствующие `includeMask`, получают `selected: true`, остальные → `false`
  - Всегда применяются `ignorePatterns` для исключения файлов
  - Директории получают `selected: true` если внутри есть выбранные файлы
- Поддержка определения языка по расширению
- Обработка ошибок доступа (permission denied → `error: true`)
- Сортировка: папки сверху, затем файлы, по имени алфавитно
- Защита от глубокой рекурсии (maxDepth = 20)
- Пути всегда с `./` и `/` в качестве разделителя

**Устаревший маршрут:** `/api/files` → возвращает `410 Gone`

---

## 8. Гибкое поле `language` (версия 2.1.2)

**Дата изменения:** 17 декабря 2025

**Описание:** Убрано жёсткое ограничение enum для поля `language` в схемах `ProjectFile`, `AiItem`, `Language`.

**Новая схема `Language`:**
```yaml
Language:
  type: string
  nullable: true
  description: Язык кода, определённый по расширению файла (например: python, javascript, sql, markdown, unknown и любые другие)
  example: sql
```

**Поддерживаемые языки на бэкенде (пример):**
- `.sql` → `sql`
- `.js/.ts/.tsx` → `javascript` / `typescript`
- `.py` → `python`
- `.java` → `java`
- `.go` → `go`
- `.md` → `markdown`
- неизвестные → `unknown`

**Причина изменения:** Необходимость поддержки SQL и других языков без постоянного обновления enum.

**Текущая версия API:** **2.1.2**

---

## Миграция для клиентов

### Обязательные изменения
1. Добавлять `context-code` во все запросы
2. Перейти с `/api/files` на `/api/project/tree`
3. Обновить валидацию по новому контракту (версия 2.1.2)

### Рекомендуемые изменения
1. Использовать `/api/kb-config` для управления настройками проекта
2. Мониторить прогресс и отчеты через новые поля и маршруты

---

## Версионирование

**Текущая версия API:** **2.1.2** (17 декабря 2025)

**Breaking changes:**
- Обязательный `context-code`
- Замена `/api/files` → `/api/project/tree`

**Non-breaking changes:**
- Новые маршруты и поля
- Расширение поддержки языков

---

## Связанные файлы

- `docs/api-contract.yaml` — основной контракт API
- `services/kbConfigService.js` — хранение и управление конфигурациями
- `routes/api.js` — реализация всех маршрутов
- `data/kb-configs/` — хранилище JSON-конфигов по контекстам

---

## Вопросы и поддержка

При возникновении вопросов или проблем с API обращайтесь к разработчикам или создавайте issue в репозитории проекта.
